# INSTRUCTIONS:
# 1. copy+paste into launch script
# 2. fill in the secrets
# 3. launch
# 4. add HTTPS/443 to firewall quickly before script proceeds to letsencrypt
# 5. associate static ip for DNS

# FILL IN THESE SECRETS
MAILGUN_API_KEY=
SENTRY_DSN=

# constants
HOME=/home/ubuntu

## SINATRA

# passenger + nginx
apt-get install -y dirmngr gnupg
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7
apt-get install -y apt-transport-https ca-certificates
sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger xenial main > /etc/apt/sources.list.d/passenger.list'
apt-get update
apt-get install -y nginx-extras passenger
sed -i '' -e 's/# \(include.*passenger.conf\)/\1/' /etc/nginx/nginx.conf
service nginx restart

# provision demo
gem install bundler
apt-get install -y libsqlite3-dev ruby-dev
cd $HOME
sudo -u ubuntu mkdir authn-demo
sudo -u ubuntu git clone https://github.com/keratin/authn-demo
cd authn-demo
sudo -u ubuntu git checkout deploy
sudo -u ubuntu bundler install --deployment --without development

# configure demo
sudo -u ubuntu cp .env.sample .env
sed -i '' -e 's;AUTHN_URL=;\0https://authn.keratin.tech;' .env
sed -i '' -e 's;APP_DOMAINS=;\0demo.keratin.tech:443;' .env
sed -i '' -e "s;SECRET_KEY_BASE=;\0$(openssl rand -hex 64);" .env
sed -i '' -e "s;HTTP_AUTH_USERNAME=;\0$(openssl rand -hex 12);" .env
sed -i '' -e "s;HTTP_AUTH_PASSWORD=;\0$(openssl rand -hex 12);" .env
echo PRIVATE_AUTHN_URL=localhost:3000 >> .env
echo APP_PASSWORD_RESET_URL=https://demo.keratin.tech/password_resets >> .env
echo MAILGUN_API_KEY=$MAILGUN_API_KEY >> .env
echo MAILGUN_DOMAIN=mg.keratin.tech >> .env
echo SENTRY_DSN=$SENTRY_DSN >> .env
echo PROXIED=true >> .env
echo PUBLIC_PORT=3001 >> .env

## AUTHN

# build authn from source
add-apt-repository -y ppa:masterminds/glide
apt-get update
apt-get install -y golang-1.9 glide
export GOPATH=~/go
export PATH=$PATH:$GOPATH/bin:/usr/lib/go-1.9/bin/
go get github.com/keratin/authn-server
go get github.com/benbjohnson/ego/cmd/ego
cd ~/go/src/github.com/keratin/authn-server
# NOTE: `git checkout v1.0.0` to install a specific version
make clean build
mv dist/authn /usr/bin/authn

# run authn as daemon with systemd
ln -s $HOME/authn-demo/deploy/authn.service /lib/systemd/system/authn.service
systemctl enable authn.service
systemctl start authn.service

## SITES

# nginx sites
ln -s $HOME/authn-demo/deploy/authn.keratin.tech /etc/nginx/sites-enabled/authn.keratin.tech
ln -s $HOME/authn-demo/deploy/demo.keratin.tech /etc/nginx/sites-enabled/demo.keratin.tech

# letsencrypt certbot
add-apt-repository -y ppa:certbot/certbot
apt-get update
apt-get install -y python-certbot-nginx
# NOTE: depends on opening 443 in the firewall
certbot -n --agree-tos \
  --nginx \
  --redirect \
  -m lance@keratin.tech \
  -d demo.keratin.tech,authn.keratin.tech
